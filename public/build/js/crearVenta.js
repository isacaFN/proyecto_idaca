let rutCliente,url,filas=0,arrayproductos=[],productosFerificados={};function iniciarapp(){productos()}function productos(){url="http://localhost/proyecto_idaca/public/api/productos",consultarAPI(url)}function buscar(){rutCliente=document.getElementById("rut").value.trim(),/^[0-9]+$/.test(rutCliente)?(url="http://localhost/proyecto_idaca/public/api/clientes",consultarAPI(url)):alert("El RUT solo debe contener nÃºmeros.")}async function consultarAPI(e){try{const t=await fetch(e),o=await t.json();e.includes("clientes")&&buscarCliente(o),e.includes("productos")&&(arrayproductos=o,autocompletar(arrayproductos))}catch(e){console.log(e)}}function autocompletar(e){document.addEventListener("focusin",(function(t){if(t.target.classList.contains("nombreProducto")){const o=t.target;let n=o.nextElementSibling;n&&n.classList.contains("sugerencias")||(n=document.createElement("div"),n.classList.add("sugerencias"),o.parentElement.appendChild(n)),o.addEventListener("input",(function(){const t=o.value.toLowerCase();n.innerHTML="";const a=e.filter((e=>e.nomprod.toLowerCase().includes(t)));a.length>0?(n.style.display="block",a.forEach((t=>{const a=document.createElement("div");a.classList.add("sugerencia"),a.textContent=t.nomprod,a.addEventListener("click",(function(){o.value=t.nomprod,n.innerHTML="",n.style.display="none";const a=o.closest("tr"),r=e.find((e=>e.nomprod===t.nomprod));if(a&&r){a.dataset.idproducto=r.codproducto;const e=a.querySelector(".codProducto"),t=a.querySelector(".precioProducto"),o=a.querySelector(".cantidadProducto"),n=a.querySelector(".subtotalProducto");e&&t&&o&&n&&(e.value=r.codproducto,t.value=r.precio,o.addEventListener("input",(function(){const e=parseFloat(o.value)||0;n.value=new Intl.NumberFormat("es-ES").format(r.precio*e),calcularSubtotalTotal()})))}})),n.appendChild(a)}))):n.style.display="none"})),document.addEventListener("click",(function(e){o.contains(e.target)||n.contains(e.target)||(n.innerHTML="",n.style.display="none")}))}}))}function calcularSubtotalTotal(){const e=document.querySelectorAll(".subtotalProducto");let t=0;e.forEach((e=>{let o=parseFloat(e.value.replace(/\./g,"").replace(",","."))||0;t+=o}));const o=document.getElementById("subtotal");o.value=new Intl.NumberFormat("es-ES").format(t),calcularMontoNeto(o.value)}function calcularMontoNeto(e){let t=parseFloat(e.replace(/\./g,"").replace(",","."))||0;const o=document.getElementById("descuento");o.addEventListener("input",(function(){if(parseFloat(o.value)>100)alert("El descuento no puede ser mayor que 100%."),o.value=100;else{const n=document.getElementById("totalDescuento");n.value=new Intl.NumberFormat("es-ES").format((parseFloat(e.replace(/\./g,"").replace(",","."))||0)*parseFloat(o.value)/100);const a=document.getElementById("montoNeto");a.value=new Intl.NumberFormat("es-ES").format(t-parseFloat(n.value.replace(/\./g,"").replace(",","."))),calcularTotal(a.value)}})),calcularTotal(e)}function calcularTotal(e){document.getElementById("iva").value=19;let t=parseFloat(e.replace(/\./g,"").replace(",","."))||0;const o=document.getElementById("totalIva");let n=19*t/100;o.value=new Intl.NumberFormat("es-ES").format(n),t=parseFloat(o.value.replace(/\./g,"").replace(",","."))||0;let a=t+parseFloat(e.replace(/\./g,"").replace(",","."));document.getElementById("total").value=new Intl.NumberFormat("es-ES").format(a)}function agregarlinea(){filas++;const e=document.createElement("tr");e.classList.add("tr");const t=document.createElement("input"),o=document.createElement("td");t.classList.add("codProducto"),t.name="codproducto",o.appendChild(t);const n=document.createElement("td"),a=document.createElement("input");a.classList.add("nombreProducto"),a.setAttribute("required","true"),a.name=`NombreProducto${filas}`,a.type="text",n.appendChild(a);const r=document.createElement("td"),c=document.createElement("input");c.classList.add("cantidadProducto"),c.type="number",c.name="cantidad",c.setAttribute("required","true"),r.appendChild(c);const l=document.createElement("td"),d=document.createElement("input");d.classList.add("precioProducto"),d.setAttribute("readonly","true"),d.name="precio",l.appendChild(d);const i=document.createElement("td"),u=document.createElement("input");u.classList.add("subtotalProducto"),u.setAttribute("readonly","true"),u.name="subtotal",i.appendChild(u),e.appendChild(o),e.appendChild(n),e.appendChild(r),e.appendChild(l),e.appendChild(i),document.getElementById("producto").appendChild(e);document.querySelector(".ocultar").style.display=producto.children.length>1?"block":"none"}function buscarCliente(e){const t=e.find((e=>e.dni===rutCliente));t?mostrar(t.dni,t.nombre):clienteNoExiste()}function clienteNoExiste(){document.getElementById("modal-datos").innerHTML='<div class="contendor-modal">\n    <div class="modal"> \n\n    <h2>Cliente no existe</h2>\n    <a class="boton_verde" href="crearCliente">\n        Crear cliente \n        <svg\n            xmlns="http://www.w3.org/2000/svg"\n            width="32"\n            height="32"\n            viewBox="0 0 24 24"\n            fill="none"\n            stroke="currentColor"\n            stroke-width="1.75"\n            stroke-linecap="round"\n            stroke-linejoin="round"\n            >\n            <path d="M12.5 8l4 4l-4 4h4.5l4 -4l-4 -4z" />\n            <path d="M3.5 8l4 4l-4 4h4.5l4 -4l-4 -4z" />\n        </svg>\n    </a>\n</div>';const e=document.querySelector(".contendor-modal");e.addEventListener("click",(function(t){t.target===e&&e.remove()}))}function mostrar(e,t){for(;nombreCliente.firstChild;)nombreCliente.removeChild(nombreCliente.firstChild);const o=document.createElement("LABEL");o.textContent="Nombre cliente:";const n=document.createElement("INPUT");n.type="text",n.classList.add("cliente"),n.value=t,nombreCliente.appendChild(o),nombreCliente.appendChild(n),document.getElementById("rut").value=e}function eliminarlinea(){if(filas--,producto.children.length>1){const e=document.getElementById("producto").lastChild,t=e.dataset.idproducto,o=parseFloat(e.querySelector(".cantidadProducto").value);void 0!==productosFerificados[t]&&(productosFerificados[t]-=o,productosFerificados[t]<=0&&delete productosFerificados[t]),e.remove()}if(1==producto.children.length){document.querySelector(".ocultar").style.display="none"}autocompletar(arrayproductos,filas),calcularSubtotalTotal(),console.log(productosFerificados)}function verificarVenta(){const e=document.querySelectorAll(".tr"),t={};arrayproductos.forEach((e=>{t[e.codproducto]=e}));for(let o=0;o<e.length;o++){const n=e[o];if("true"===n.dataset.processed)continue;const a=n.dataset.idproducto;if(t[a]){let e=parseFloat(n.querySelector(".cantidadProducto").value);isNaN(e)||insertarProducto(a,e)}n.dataset.processed="true"}enviarProductosVerificados()}function insertarProducto(e,t){void 0!==productosFerificados[e]?productosFerificados[e]+=t:productosFerificados[e]=t}async function enviarProductosVerificados(){console.log(productosFerificados);JSON.stringify(productosFerificados)}document.addEventListener("DOMContentLoaded",(function(){iniciarapp()})),window.buscar=buscar,window.agregarlinea=agregarlinea,window.eliminarlinea=eliminarlinea,window.verificarVenta=verificarVenta,window.enviarProductosVerificados=enviarProductosVerificados;