let rutCliente,url,filas=0,arrayproductos=[];function iniciarapp(){productos()}function productos(){url="http://localhost/proyecto_idaca/public/api/productos",consultarAPI(url)}function buscar(){rutCliente=document.getElementById("rut").value.trim(),/^[0-9]+$/.test(rutCliente)?(url="http://localhost/proyecto_idaca/public/api/clientes",consultarAPI(url)):alert("El RUT solo debe contener nÃºmeros.")}async function consultarAPI(e){try{const t=await fetch(e),n=await t.json();e.includes("clientes")&&buscarCliente(n),e.includes("productos")&&(arrayproductos=n,autocompletar(arrayproductos))}catch(e){console.log(e)}}function autocompletar(e){document.addEventListener("focusin",(function(t){if(t.target.classList.contains("nombreProducto")){const n=t.target;let o=n.nextElementSibling;o&&o.classList.contains("sugerencias")||(o=document.createElement("div"),o.classList.add("sugerencias"),n.parentElement.appendChild(o)),n.addEventListener("input",(function(){const t=n.value.toLowerCase();o.innerHTML="";const a=e.filter((e=>e.nomprod.toLowerCase().includes(t)));a.length>0?(o.style.display="block",a.forEach((t=>{const a=document.createElement("div");a.classList.add("sugerencia"),a.textContent=t.nomprod,a.addEventListener("click",(function(){n.value=t.nomprod,o.innerHTML="",o.style.display="none";const a=n.closest("tr"),l=e.find((e=>e.nomprod===t.nomprod));if(a&&l){const e=a.querySelector(".codProducto"),t=a.querySelector(".precioProducto"),n=a.querySelector(".cantidadProducto"),o=a.querySelector(".subtotalProducto");e&&t&&n&&o&&(e.value=l.codproducto,t.value=l.precio,n.addEventListener("input",(function(){const e=parseFloat(n.value)||0;o.value=new Intl.NumberFormat("es-ES").format(l.precio*e),calcularSubtotalTotal()})))}})),o.appendChild(a)}))):o.style.display="none"})),document.addEventListener("click",(function(e){n.contains(e.target)||o.contains(e.target)||(o.innerHTML="",o.style.display="none")}))}}))}function calcularSubtotalTotal(){const e=document.querySelectorAll(".subtotalProducto");let t=0;e.forEach((e=>{let n=parseFloat(e.value.replace(/\./g,"").replace(",","."))||0;t+=n}));const n=document.getElementById("subtotal");n.value=new Intl.NumberFormat("es-ES").format(t),calcularMontoNeto(n.value)}function calcularMontoNeto(e){let t=parseFloat(e.replace(/\./g,"").replace(",","."))||0;const n=document.getElementById("descuento");n.addEventListener("input",(function(){if(parseFloat(n.value)>100)alert("El descuento no puede ser mayor que 100%."),n.value=100;else{const o=document.getElementById("totalDescuento");o.value=new Intl.NumberFormat("es-ES").format((parseFloat(e.replace(/\./g,"").replace(",","."))||0)*parseFloat(n.value)/100);const a=document.getElementById("montoNeto");a.value=new Intl.NumberFormat("es-ES").format(t-parseFloat(o.value.replace(/\./g,"").replace(",","."))),calcularTotal(a.value)}})),calcularTotal(e)}function calcularTotal(e){document.getElementById("iva").value=19;let t=parseFloat(e.replace(/\./g,"").replace(",","."))||0;const n=document.getElementById("totalIva");let o=19*t/100;n.value=new Intl.NumberFormat("es-ES").format(o),t=parseFloat(n.value.replace(/\./g,"").replace(",","."))||0;let a=t+parseFloat(e.replace(/\./g,"").replace(",","."));document.getElementById("total").value=new Intl.NumberFormat("es-ES").format(a)}function agregarlinea(){filas++;const e=document.createElement("tr");e.classList.add("trVenta");const t=document.createElement("input"),n=document.createElement("td");t.classList.add("codProducto"),t.name="codproducto",n.appendChild(t);const o=document.createElement("td"),a=document.createElement("input");a.classList.add("nombreProducto"),a.setAttribute("required","true"),a.name=`NombreProducto${filas}`,a.type="text",o.appendChild(a);const l=document.createElement("td"),c=document.createElement("input");c.classList.add("cantidadProducto"),c.type="number",c.name="cantidad",c.setAttribute("required","true"),l.appendChild(c);const r=document.createElement("td"),d=document.createElement("input");d.classList.add("precioProducto"),d.setAttribute("readonly","true"),d.name="precio",r.appendChild(d);const u=document.createElement("td"),i=document.createElement("input");i.classList.add("subtotalProducto"),i.setAttribute("readonly","true"),i.name="subtotal",u.appendChild(i),e.appendChild(n),e.appendChild(o),e.appendChild(l),e.appendChild(r),e.appendChild(u),document.getElementById("producto").appendChild(e);document.querySelector(".ocultar").style.display=producto.children.length>1?"block":"none"}function buscarCliente(e){e.forEach((e=>{const{dni:t,nombre:n}=e;t===rutCliente&&mostrar(t,n)}))}function mostrar(e,t){for(;nombreCliente.firstChild;)nombreCliente.removeChild(nombreCliente.firstChild);const n=document.createElement("LABEL");n.textContent="Nombre cliente:";const o=document.createElement("INPUT");o.type="text",o.classList.add("cliente"),o.value=t,nombreCliente.appendChild(n),nombreCliente.appendChild(o),document.getElementById("rut").value=e}function eliminarlinea(){if(filas--,producto.children.length>1){document.getElementById("producto").lastChild.remove()}if(1==producto.children.length){document.querySelector(".ocultar").style.display="none"}autocompletar(arrayproductos,filas),calcularSubtotalTotal()}function verificarVenta(){let e=0;document.querySelectorAll(".cantidadProducto").forEach((t=>{let n=parseFloat(t.value)||0;e+=n})),console.log(e)}document.addEventListener("DOMContentLoaded",(function(){iniciarapp()})),window.buscar=buscar,window.agregarlinea=agregarlinea,window.eliminarlinea=eliminarlinea,window.verificarVenta=verificarVenta;